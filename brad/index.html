<html lang="en">
<head>
    <title>COMSputer</title>
    <style>

        html {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }

        #messages-container {
            position: fixed;
            bottom: calc(20px + 4%);
            width: 95%;
            right: 5%;
            overflow-y: scroll;
            overflow-x: hidden;
            flex-direction: column-reverse;
            max-height: calc(92% + 10px);
        }

        #messages-container::-webkit-scrollbar {
            display: none;
        }

        #fade {
            position: absolute;
            display: block;
            width: 100%;
            height: calc(8% + 30px);
            background: linear-gradient(to bottom, rgba(255, 255, 255, 1) 10px, rgba(255, 255, 255, 0) 100%);
            top: 0;
        }

        #span {
            position: fixed;
            top: 1%;
            right: 1%;
            padding: 5px;
            opacity: 0.6;
            border: none;
            background-color: #BEBEBE;
            cursor: pointer;
        }

        #span:hover {
            background-color: #CDCDCD;
            opacity: 0.9;
        }

        #phone {
            background-color: white;
            width: 90%;
            height: 94%;
            position: absolute;
            border: 10px solid #BEBEBE;
            top: calc(2% - 10px);
            left: calc(5% - 10px);
            border-radius: 2vh;
        }

        .phone-text {
            color: #BEBEBE;
            font-size: Max(4vh, 4vw);
            font-family: Arial, sans-serif;
            text-align: center;
            margin: auto;
            position: absolute;
            top: 40%;
            height: 50%;
            left: 3%;
            transform: translateY(-50%);
            width: 94%;
        }

        #clear-btn {
            position: absolute;
            bottom: calc(5% + 5px);
            left: 50%;
            width: 80%;
            height: 10%;
            background-color: #0d4a83;
            border: none;
            border-radius: 4%;
            transform: translateX(-50%);
            color: #fff;
            font-size: Max(4vh, 3vw);
            text-align: center;
            cursor: pointer;
        }

        #clear-btn:hover {
            filter: brightness(85%);
        }

        #gray-rectangle {
            width: 90%;
            height: 40px;
            background-color: #BEBEBE;
            border-radius: 5px;
            margin-bottom: 2%;
            left: 5%;
            position: fixed;
            right: 5%;
            display: none;
        }

        #send-message {
            position: absolute;
            top: 5px;
            right: 8px;
            opacity: 0.6;
            border: none;
            background-color: transparent;
            border-radius: 5px;
            cursor: pointer;
        }

        #send-message:hover {
            opacity: 0.7;
            background-color: #CACACA;
        }

        #message-input {
            position: absolute;
            left: 8px;
            right: 61px;
            top: 5px;
            bottom: 5px;
            background-color: #BEBEBE;
            border: none;
            font-size: 18px;
            padding: 0 10px;
            color: rgba(0, 0, 0, 0.4);
            outline: none;
        }

        #message-input::placeholder {
            color: #999;
            opacity: 1;
        }

        #credits {
            position: fixed;
            bottom: 0;
            left: 5%;
            right: 5%;
            height: 1%;
            background-color: transparent;
            border: none;
            font-size: 2vh;
            padding: 10px;
            color: rgba(0, 0, 0, 0.4);
            outline: none;
            vertical-align: bottom;
            text-align: center;
        }

        .message {
            position: relative;
            width: 45%;
            bottom: 30px;
            background-color: transparent;
            font-size: 18px;
            padding: 10px;
            padding-bottom: 0;
            display: none;
            color: rgba(0, 0, 0, 0.4);
            font-family: Arial, sans-serif;
            text-align: right;
            word-wrap: break-word;
        }

        .image {
            position: relative;
            left: calc(10.3% - 60px);
            top: -26.6px;
            border: none;
            width: 60px;
            height: 60px;
            background-size: 61.2px 100%;
            background-repeat: no-repeat;
            background-image: url("./Untitled drawing.svg");
            background-color: transparent;
            z-index: 1;
        }

        .image::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 30%;
            width: 50%;
            height: 25%;
            background-color: white;
            z-index: 2;
        }

        .feedback-button {
            position: absolute;
            bottom: -10px;
            height: 20px;
            width: 20px;
            right: 2%;
            background-size: 70% 80%;
            background-repeat: no-repeat;
            opacity: 0.6;
            background-position: center center;
            border-radius: 50%;
            background-image: url("https://cdn-icons-png.flaticon.com/512/25/25297.png");
            z-index: 4;
            border: none;
        }

        .feedback-button:hover {
            opacity: 0.95;
        }

        .thank {
            position: absolute;
            font-size: 14px;
            bottom: -20px;
            height: 19.5px;
            width: 100%;
            opacity: 0;
            color: rgba(0, 0, 0, 0.4);
            font-family: Arial, sans-serif;
            text-align: left;
            transition: opacity 0.5s ease-in-out;
        }

        .thank.fade-in {
            opacity: 1;
        }

        .thank.fade-out {
            opacity: 0;
        }

        .response {
            position: relative;
            left: 10%;
            width: fit-content;
            max-width: 45%;
            background-color: #0d4a83;
            border-radius: 5px 5px 5px 0;
            font-size: 18px;
            padding: 10px;
            display: flex;
            color: rgb(255, 255, 255);
            font-family: Arial, sans-serif;
            text-align: left;
            word-wrap: break-word;
            z-index: 3;
        }

        #scroll-down-btn {
            position: fixed;
            margin-bottom: 2%;
            right: 1%;
            border-radius: 5px;
            width: 3%;
            height: 40px;
            background-color: #BEBEBE;
            border: none;
            background-size: 5%;
            transition: opacity 0.05s ease-in-out;
            overflow: hidden;
        }

        #scroll-down-btn::before {
            content: "";
            position: absolute;
            top: 12%;
            left: 10%;
            width: 80%;
            height: 80%;
            background-image: url("https://cdn-icons-png.flaticon.com/512/60/60920.png");
            background-size: 100%;
            background-position: center center;
            background-repeat: no-repeat;
            opacity: 0.3;
        }

        #scroll-down-btn.hide {
            opacity: 0;
        }
    </style>
</head>
<body>
<div id="messages-container"></div>
<div id="fade"></div>
<div id="phone">
    <div class="phone-text">
        The COMSputer is currently updating. The update should be completed today, March 17th, by 5:00 PM Eastern Time. We apoligize for any inconvenience.
    </div>
    <button id="clear-btn" onclick="clearMessage()">Dismiss</button>
</div>
<div id="gray-rectangle">
    <input type="text" id="credits" value="Made by Maxwell Cosenza & Michael Canudas" readonly>
    <button id="send-message" onclick="checkReady()">
        <img src="https://icons.veryicon.com/png/o/miscellaneous/ui-basic-linear-icon/send-message-2-2.png" width = "25px" height = "30px"/>
    </button>
    <input id="message-input" type="text" placeholder="Ask me a question">
    <button id="span" onclick="spanish()">Espa√±ol</button>
</div>
<button id="scroll-down-btn" class="hide">
    <i class="fa fa-chevron-down"></i>
</button>

<script>
    let messagesContainer = document.getElementById("messages-container");
    let grayRec = document.getElementById("gray-rectangle");
    let phone = document.getElementById("phone");
    let scrollDownBtn = document.getElementById('scroll-down-btn');
    let messages = [];
    let responses = [];
    let images = [];
    let upButtons = [];
    let downButtons = [];
    let pastRequests = [];

    let reformatRequired = false;
    let ready = true
    let span = false

    var userAgent = navigator.userAgent.toLowerCase();
    var isMobile = /mobile|android|iphone|ipad|phone/i.test(userAgent);
    if (isMobile || !isMobile) {
        var metaViewport = document.querySelector("meta[name=viewport]");
        if (metaViewport) {
            metaViewport.setAttribute("content", "width=device-width, initial-scale=1.0, user-scalable=no");
        }

        phone.style.display = "block";
        messagesContainer.style.display = "None";
        grayRec.style.display = "None";

        let credits = document.getElementById("credits");
        let sendButtonImg = document.querySelector('#send-message img');
        let messageInput = document.getElementById("message-input")
        let spanButton = document.getElementById("span")
        let fade = document.getElementById("fade")

        fade.style.display = "None";
        messageInput.style.fontSize = "50px";
        messageInput.style.padding = "20px";
        messageInput.style.width = "85%";
        messagesContainer.style.bottom = "calc(4% + 100px)";
        messagesContainer.style.maxHeight = "calc(91% - 110px)";
        sendButtonImg.width = 95;
        sendButtonImg.height = 112;
        spanButton.style.fontSize = "36px";
        spanButton.style.padding = "10px";
        spanButton.style.right = "3%";
        grayRec.style.height = "120px";
        grayRec.style.bottom = grayRec.style.bottom + 40;
        credits.style.display = "None";
        grayRec.style.borderRadius = "25px";
    } else {
        phone.style.display = "None";
        messagesContainer.style.display = "Block";
        grayRec.style.display = "Block";
    }

    const textList1 = ["try, ", "ask, ", "A common question I get is, "];
    const probabilities1 = [0.6, 0.35, 0.05];
    const textList2 = ["\"What time does the rivalry baseball game start?\"", "\"Who is the Boys Tennis Team playing next?\"", "\"What day can I get my sports physical?\"", "\"Where is the Girls Volleyball game?\"", "\"When does winter recess start?\"", "\"What district-wide events are tomorrow?\""];

        //"\"When's the next Board of Education Meeting?\"",
        //"\"What time does the football game start?\"",

    //const probabilities2 = [0.2, 0.2, 0.15, 0.15, 0.15, 0.1, 0.05]
    const probabilities2 = [ 0.25, 0.20, 0.20, 0.20, 0.1, 0.05]

    const inputBox = document.getElementById("message-input");
    setInterval(() => {
        const randomIndex1 = weightedRandomIndex(probabilities1);
        const randomIndex2 = weightedRandomIndex(probabilities2);
        if (!span && !isMobile) {
            inputBox.setAttribute("placeholder", textList1[randomIndex1] + textList2[randomIndex2]);
            setTimeout(() => {
                inputBox.setAttribute("placeholder", "Ask me a question");
            }, Math.floor(Math.random() * (10001 - 3000) + 3000));
        }
    }, Math.floor(Math.random() * (20001 - 12500) + 12500));

    function weightedRandomIndex(probabilities) {
        const r = Math.random();
        let cumulativeProbability = 0;
        for (let i = 0; i < probabilities.length; i++) {
            cumulativeProbability += probabilities[i];
            if (r < cumulativeProbability) {
                return i;
            }
        }
    }


    function clearMessage() {
        phone.style.display = "None";
        messagesContainer.style.display = "Block";
        grayRec.style.display = "Block";
    }

    const fade = document.getElementById('fade');

    messagesContainer.addEventListener('scroll', () => {
        if (messagesContainer.scrollTop !== 0) {
            fade.style.display = 'block';
            fade.style.height = Math.max((Math.min(messagesContainer.scrollTop, (window.innerHeight * (8 / 100) + 30))), 15);
        } else {
            fade.style.display = 'none';
        }
    });

    function spanish() {
        let spanButton = document.getElementById("span");
        let inputMessage = document.getElementById("message-input");
        let defaultMessage = responses[responses.length - 1];
        let feedbackMessage = responses[responses.length - 2];
        let credits = document.getElementById("credits")
        if (span === false) {
            spanButton.innerHTML = "English";
            inputMessage.placeholder = "Hazme una pregunta";
            //defaultMessage.innerHTML = "¬°Hola! ¬°Soy el COMSputer! ¬°Soy su asistente virtual para el sitio web del distrito de Comsewogue!";
            defaultMessage.innerHTML = "¬°Hola! ¬°Soy el COMSputer! ¬°Soy su asistente virtual para el sitio web del distrito de Comsewogue! H√°game una pregunta como, \'¬øQu√© d√≠a es la pr√≥xima reuni√≥n de la Junta de Educaci√≥n?\' o \'¬øA qu√© hora comenz√≥ el √∫ltimo partido de f√∫tbol?\'";
            credits.value = "Hecho por Maxwell Cosenza & Michael Canudas";
            feedbackMessage.innerHTML = "A lo largo de nuestra conversaci√≥n, ayude a mejorar la COMsputer presionando los pulgares hacia arriba si respondo con la respuesta que quer√≠a o los pulgares hacia abajo si estaba buscando algo m√°s.";
            formatPastMessages();
            span = true;
        } else {
            spanButton.innerHTML = "Espa√±ol";
            inputMessage.placeholder = "Ask me a question";
            // defaultMessage.innerHTML = "Hello! I am the COMSputer! I am your virtual assistant for the Comsewogue District Website!";
            defaultMessage.innerHTML = "Hello! I am the COMSputer! I am your virtual assistant for the Comsewogue District Website! Ask me a question like, \'What day is the next Board of Education Meeting?\' or \'What time did the last football game start?\'";
            credits.value = "Made by Maxwell Cosenza & Michael Canudas";
            feedbackMessage.innerHTML = "Throughout our conversation, help improve the COMSputer by pressing the thumbs up if I respond with the answer you wanted or the thumbs down if you were looking for something else!";
            formatPastMessages();
            span = false;
        }
    }

    function defaultMessage() {

        let response = document.createElement("div");
        response.classList.add("response");
        if (isMobile) {
            mobileFormat(response, 65)
            response.style.left = "20%";
        }
        messagesContainer.appendChild(response);
        responses.unshift(response);

        response.style.display = "block";
        response.style.height = "auto";
        //response.innerHTML = "Hello! I am the COMSputer! I am your virtual assistant for the Comsewogue District Website!";
        response.innerHTML = "Hello! I am the COMSputer! I am your virtual assistant for the Comsewogue District Website! Ask me a question like, \'What day is the next Board of Education Meeting?\' or \'What time did the last football game start?\'";

        let image = document.createElement("div");
        image.classList.add("image");
        if (isMobile) {
            image.style.transform = "scale(3)";
            image.style.left = "calc(10.3% - 20px)";
        }
        messagesContainer.appendChild(image);
        images.unshift(image);
        image.style.display = "block";

        let container = document.getElementById("messages-container");
        container.style.height = container.style.height - 60 + "px";

        formatPastMessages();
        feedbackMessage();
    }

    function feedbackMessage() {
        let response = document.createElement("div");
        response.classList.add("response");
        if (isMobile) {
            mobileFormat(response, 65)
            response.style.left = "20%";
        }
        messagesContainer.appendChild(response);
        responses.unshift(response);

        response.style.display = "block";
        response.style.height = "auto";
        response.innerHTML = "Throughout our conversation, help improve the COMSputer by pressing the thumbs up if I respond with the answer you wanted or the thumbs down if you were looking for something else!";

        let image = document.createElement("div");
        image.classList.add("image");
        if (isMobile) {
            image.style.transform = "scale(3)";
            image.style.left = "calc(10.3% - 20px)";
        }
        messagesContainer.appendChild(image);
        images.unshift(image);
        image.style.display = "block";

        let container = document.getElementById("messages-container");
        container.style.height = container.style.height - 60 + "px";

        formatPastMessages();
        defualtResponse = responses[responses.length - 1]
        defaultImage = images[images.length - 1]
        defualtResponse.style.top = "30px";
        defaultImage.style.top = "3.4px";
    }

    function checkReady() {
        if (ready === true) {
            ready = false
            getMessage();
        }
    }

    async function getMessage() {

        const raw = document.getElementById("message-input");

        if (raw.value.trim() === '') {
            ready = true;
            return;
        }

        const input = raw.value
        document.getElementById("message-input").value = "";

        let message = document.createElement("div");
        message.classList.add("message");
        if (isMobile) {
            mobileFormat(message, 80)
        }
        messagesContainer.appendChild(message);
        messages.unshift(message);

        message.style.display = "block";
        message.style.height = "auto";
        message.innerHTML = input;
        message.value = "";

        formatPastMessages();

        let response = document.createElement("div");
        response.classList.add("response");
        if (isMobile) {
            mobileFormat(response, 65)
            response.style.left = "20%";
        }
        messagesContainer.appendChild(response);
        responses.unshift(response);

        response.style.display = "block";
        response.style.height = "auto";

        const returnedData = await fetch("https://david-sra62.ondigitalocean.app", {
            method: "POST",
            mode: "cors",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "question": input,
                "past_requests": pastRequests,
                "spanish": span
            })
        });

        const responseText = await returnedData.text();
        const responseData = JSON.parse(responseText);
        response.innerHTML = responseData.response;
        const foundResults = responseData.success;

        pastRequests.push(input)

        if (foundResults === true) {
            let upButton = document.createElement("button");
            upButton.classList.add("feedback-button");
            response.appendChild(upButton);
            upButton.style.backgroundColor = "rgb(95,223,95)";
            upButtons.unshift(upButton);

            let downButton = document.createElement("button");
            downButton.classList.add("feedback-button");
            response.appendChild(downButton);
            downButton.style.transform = "scaleY(-1)";
            downButton.style.backgroundColor = "rgb(233,95,95)";
            downButtons.unshift(downButton);

            if (isMobile) {
                upButton.style.transform = "scale(4)";
                downButton.style.transform = "scale(-4)";
                upButton.style.right = "calc(6% + 100px)";
                downButton.style.right = "40px"
            } else {
                upButton.style.right = "calc(3% + 20px)";
            }

            upButton.addEventListener("click", function () {
                giveFeedback(response, upButton, downButton);
            });
            downButton.addEventListener("click", function () {
                giveFeedback(response, upButton, downButton);
            });
        }

        let image = document.createElement("div");
        image.classList.add("image");
        if (isMobile) {
            image.style.transform = "scale(3)";
            image.style.left = "calc(10.3% - 20px)";
        }
        messagesContainer.appendChild(image);
        images.unshift(image);
        image.style.display = "block";

        formatPastMessages(true);
    }

    function mobileFormat(item, width) {
        item.style.maxWidth = width + "%";
        item.style.fontSize = "50px";
        item.style.padding = "30px";
        item.style.borderRadius = "30px 30px 30px 0px";
    }

    function giveFeedback(response, upButton, downButton) {
        upButton.style.display = "none";
        upButton.setAttribute('disabled', true);
        downButton.style.display = "none";
        downButton.setAttribute('disabled', true);

        let thank = document.createElement("div");
        thank.classList.add("thank", "fade-in");
        response.appendChild(thank);
        thank.style.display = "block";
        if (span === false) {
            thank.innerHTML = "Thank you for the feedback!";
        } else {
            thank.innerHTML = "¬°Gracias por los comentarios!";
        }

        if (isMobile) {
            thank.style.fontSize = "35px";
        }

        formatPastMessages();

        setTimeout(function () {
            thank.classList.add("fade-out");
            setTimeout(function () {
                thank.parentNode.removeChild(thank);
            }, 500);
        }, 3000);
    }

    function formatPastMessages(readyUp = false) {

        let credits = document.getElementById("credits");
        let container = document.getElementById("messages-container")

        if (window.innerHeight < 570 || isMobile) {
            credits.style.display = "none";
        } else {
            credits.style.display = "flex";
        }

        container.style.width = "95%";

        for (let i = 0; i < messages.length; i++) {

            let message = messages[i];
            message.style.left = container.offsetWidth - message.offsetWidth + "px";
        }

        container.scrollTop = container.scrollHeight;

        if (readyUp === true) {
            ready = true;
        }
    }

    if (ready && reformatRequired) {
        reformatRequired = false;
        formatPastMessages();
    }

    const inputElement = document.getElementById("message-input");
    inputElement.addEventListener("keydown", (event) => {
        if (event.keyCode === 13) {
            checkReady();
        }
    });

    window.addEventListener("resize", function () {
        if (ready) {
            formatPastMessages();
        } else {
            reformatRequired = true;
        }
    });

    function checkButton() {
        if (messagesContainer.scrollHeight - messagesContainer.scrollTop > messagesContainer.clientHeight && !isMobile) {
            scrollDownBtn.classList.remove('hide');
            scrollDownBtn.removeAttribute('disabled');
        } else {
            scrollDownBtn.classList.add('hide');
            scrollDownBtn.setAttribute('disabled', true);
        }
    }

    messagesContainer.addEventListener('scroll', () => checkButton());

    scrollDownBtn.addEventListener('click', () => {
        const targetScrollTop = messagesContainer.scrollHeight - messagesContainer.clientHeight;
        const scrollStep = Math.round(targetScrollTop / 10);
        const scrollToBottom = () => {
            if (messagesContainer.scrollTop < targetScrollTop) {
                messagesContainer.scrollTop += scrollStep;
                requestAnimationFrame(scrollToBottom);
            } else {
                messagesContainer.scrollTop = targetScrollTop;
            }
        };
        scrollToBottom();
        scrollDownBtn.classList.add('hide');
        scrollDownBtn.setAttribute('disabled', true);
    });

    window.addEventListener("load", defaultMessage);
    window.addEventListener("resize", checkButton);
</script>
</body>
</html>
